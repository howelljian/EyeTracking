<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eye-Tracking</title>
    
    <!-- Link to Google Fonts (Gugi) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Gugi&display=swap" rel="stylesheet">

    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: "Gugi", sans-serif;
            font-weight: 400;
            font-style: normal;
            background-color: #f0f0f0;
        }

        #calibration-screen {
            position: absolute;
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: rgb(255, 255, 255);
            color: rgb(0, 0, 0);
            z-index: 100;
            flex-direction: column;
        }

        #calibration-points {
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: space-around;
            align-items: center;
            flex-wrap: wrap;
        }

        .calibration-point {
            width: 20px;
            height: 20px;
            background-color: red;
            border-radius: 50%;
            cursor: pointer;
        }

        #calibration-instructions {
            font-size: 24px;
            margin-bottom: 20px;
        }

        #main-screen {
            display: none;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }

        .section {
            width: 150px;
            height: 600px;
            margin: 10px;
            border: 1px solid black;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 18px;
            background-color: white;
        }

        .highlight {
            background-color: rgb(103, 184, 255);
        }
    </style>
</head>
<body>

    <!-- Calibration Screen -->
    <div id="calibration-screen">
        <div id="calibration-instructions" style="margin-top: 60px;">Click on the red circles to calibrate</div>
        <div id="calibration-points">
            <div class="calibration-point" style="top: 10%; left: 10%;"></div>
            <div class="calibration-point" style="top: 10%; right: 10%;"></div>
            <div class="calibration-point" style="bottom: 10%; left: 10%;"></div>
            <div class="calibration-point" style="bottom: 10%; right: 10%;"></div>
            <div class="calibration-point" style="top: 50%; left: 50%;"></div>
        </div>
    </div>

    <!-- Main Screen with Eye-Tracking Sections -->
    <div id="main-screen">
        <div class="section" id="section1">Section 1</div>
        <div class="section" id="section2">Section 2</div>
        <div class="section" id="section3">Section 3</div>
        <div class="section" id="section4">Section 4</div>
        <div class="section" id="section5">Section 5</div>
        <div class="section" id="section6">Section 6</div>
        <div class="section" id="section7">Section 7</div>
        <div class="section" id="section8">Section 8</div>
    </div>

    <script src="https://webgazer.cs.brown.edu/webgazer.js"></script>
    <script>
        window.onload = function() {
            setupCalibration();
        };

        let calibrationClicks = 0;
        let pointClickCounts = {}; // To store the click count for each point

        // Function to set up calibration
        function setupCalibration() {
            const calibrationPoints = document.querySelectorAll('.calibration-point');

            calibrationPoints.forEach((point, index) => {
                pointClickCounts[index] = 0; // Initialize click count for each point

                point.addEventListener('click', function() {
                    pointClickCounts[index]++;
                    updatePointColor(this, pointClickCounts[index]);

                    // Only record screen position after 5 clicks
                    if (pointClickCounts[index] === 5) {
                        calibrationClicks++;
                        webgazer.recordScreenPosition(this.offsetLeft + this.offsetWidth / 2, this.offsetTop + this.offsetHeight / 2);

                        if (calibrationClicks >= 5) {
                            document.getElementById('calibration-screen').style.display = 'none';
                            document.getElementById('main-screen').style.display = 'flex';
                            startEyeTracking();
                        }
                    }
                });
            });
        }

        // Function to update point color based on the number of clicks
        function updatePointColor(point, clickCount) {
            if (clickCount === 1) {
                point.style.backgroundColor = 'orange'; // After 1st click
            } else if (clickCount === 2) {
                point.style.backgroundColor = 'yellow'; // After 2nd click
            } else if (clickCount === 3) {
                point.style.backgroundColor = 'lightgreen'; // After 3rd click
            } else if (clickCount === 4) {
                point.style.backgroundColor = 'green'; // After 4th click
            }
            // 5th click will trigger gaze recording and final green color will be kept
        }

        // Eye-tracking functionality
        function startEyeTracking() {
            webgazer.setGazeListener(function(data, elapsedTime) {
                if (data) {
                    // Gaze data received
                    const x = data.x;
                    const y = data.y;
                    const focusedSection = getSectionByCoordinates(x, y);
                    if (focusedSection) {
                        highlightSection(focusedSection);
                        updateFocusDuration(focusedSection);
                    } else {
                        resetFocus();
                    }
                }
            }).begin();
        }

        let currentSection = null;
        let focusStartTime = null;

        function getSectionByCoordinates(x, y) {
            const sections = document.querySelectorAll('.section');
            for (let section of sections) {
                const rect = section.getBoundingClientRect();
                if (x >= rect.left && x <= rect.right && y >= rect.top && y <= rect.bottom) {
                    return section;
                }
            }
            return null;
        }

        function highlightSection(section) {
            if (currentSection !== section) {
                if (currentSection) currentSection.classList.remove('highlight');
                section.classList.add('highlight');
                currentSection = section;
                focusStartTime = new Date();
            }
        }

        function updateFocusDuration(section) {
            const now = new Date();
            const focusDuration = (now - focusStartTime) / 1000; // In seconds
            section.innerText = section.id + ' (Focus Duration: ' + focusDuration.toFixed(2) + 's)';
        }

        function resetFocus() {
            if (currentSection) {
                currentSection.classList.remove('highlight');
                currentSection.innerText = currentSection.id;
                currentSection = null;
                focusStartTime = null;
            }
        }
    </script>
</body>
</html>
